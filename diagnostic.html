<!DOCTYPE html>
<html>
<head>
    <title>LSP Diagnostic Test</title>
</head>
<body>
    <h1>LSP Relationship Navigation Diagnostic</h1>
    <div id="results"></div>
    
    <script type="module">
        const resultsDiv = document.getElementById('results');
        
        function log(message) {
            const p = document.createElement('p');
            p.textContent = message;
            resultsDiv.appendChild(p);
            console.log(message);
        }
        
        async function runDiagnostic() {
            log('üöÄ Starting LSP Diagnostic...');
            
            try {
                // Check if LSP module is available
                const { FormulaLanguageServer } = await import('./lsp.js');
                log('‚úÖ LSP module imported successfully');
                
                // Create mock schema
                const mockSchema = {
                    customer: {
                        columns: [
                            { column_name: 'id', data_type: 'integer' },
                            { column_name: 'first_name', data_type: 'text' },
                            { column_name: 'assigned_rep_id', data_type: 'integer' }
                        ],
                        relationships: [
                            { relationship_name: 'assigned_rep_id', target_table_name: 'rep' }
                        ]
                    },
                    rep: {
                        columns: [
                            { column_name: 'id', data_type: 'integer' },
                            { column_name: 'name', data_type: 'text' },
                            { column_name: 'commission_rate', data_type: 'decimal' }
                        ]
                    }
                };
                
                // Create LSP instance
                const lsp = new FormulaLanguageServer(mockSchema);
                log('‚úÖ LSP instance created');
                
                // Test parseRelationshipNavigation
                const relNav = lsp.parseRelationshipNavigation('assigned_rep_id_rel.');
                log(`üìä parseRelationshipNavigation result: ${JSON.stringify(relNav)}`);
                
                if (relNav) {
                    log('‚úÖ parseRelationshipNavigation works');
                    
                    // Test resolveTargetTable
                    const targetTable = lsp.resolveTargetTable(relNav, 'customer');
                    log(`üìä resolveTargetTable result: ${targetTable}`);
                    
                    if (targetTable) {
                        log(`‚úÖ resolveTargetTable works: customer ‚Üí ${targetTable}`);
                        
                        // Test getRelatedFieldCompletions
                        const completions = lsp.getRelatedFieldCompletions(targetTable, '', relNav, false);
                        log(`üìä getRelatedFieldCompletions count: ${completions.length}`);
                        
                        if (completions.length > 0) {
                            log('‚úÖ getRelatedFieldCompletions works');
                            completions.slice(0, 3).forEach((comp, i) => {
                                log(`   ${i + 1}. ${comp.label} (${comp.detail})`);
                            });
                        } else {
                            log('‚ùå getRelatedFieldCompletions returned no results');
                        }
                    } else {
                        log('‚ùå resolveTargetTable failed');
                    }
                } else {
                    log('‚ùå parseRelationshipNavigation failed');
                }
                
                log('üéâ Diagnostic complete!');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                log(`Stack: ${error.stack}`);
            }
        }
        
        runDiagnostic();
    </script>
</body>
</html>
